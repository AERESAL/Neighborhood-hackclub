<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Print Activities | VolunteerHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="dashboard-theme.css">
  <script src="dashboard-theme.js"></script>
  <style>
    :root {
      --accent: #2563eb;
      --color2: #22d3ee;
    }
    body {
      font-family: Lexend Deca, Montserrat, Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 4px 24px #0001;
      padding: 32px 24px 24px 24px;
    }
    .preview {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0001;
      padding: 24px;
      margin-top: 24px;
    }
    .accent-btn {
      background: var(--accent, #2563eb);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-weight: 600;
      font-size: 16px;
      transition: background 0.2s;
    }
    .accent-btn:hover {
      background: #1e40af;
    }
    .checkbox {
      accent-color: var(--accent, #2563eb);
      width: 18px;
      height: 18px;
    }
    @media (max-width: 700px) {
      .container { padding: 10px; }
      .preview { padding: 10px; }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <video autoplay muted loop id="backgroundVideo" class="prevent-select" style="position:fixed;width:100%;height:100%;object-fit:cover;z-index:-1;display:none;">
    <source src="https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4" type="video/mp4">
  </video>
    <!-- Header (copied from dashboard.html/community.html) -->
    <header class="flex items-center justify-between bg-white shadow-md px-6 py-4 fixed top-0 left-0 w-full z-50">
      <h1 class="text-xl font-bold text-gray-700">VolunteerHub</h1>
      <div class="relative flex items-center gap-4">
        <img src="https://i.ibb.co/xt48j1sq/1.png" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300 cursor-pointer" onclick="toggleMenu()">
        <div id="profileMenu" class="hidden absolute top-16 right-0 w-44 shadow-lg rounded-md z-50 border transition-colors">
          <ul class="py-2 text-sm" id="profileMenuList">
            <li><a href="#" class="block px-4 py-2">Profile</a></li>
            <li><button class="w-full text-left block px-4 py-2 text-red-600">Log Out</button></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="flex flex-1">
      <!-- Sidebar (copied from dashboard.html/community.html) -->
      <aside class="w-64 h-[100vh] bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-200 shadow-md flex flex-col justify-between fixed pt-24">
        <nav class="mt-6 flex-1">
          <ul class="space-y-2">
            <li><a href="dashboard.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Dashboard</a></li>
            <li><a href="community.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Community</a></li>
            <li><a href="find-activities.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Find Activities</a></li>
          </ul>
        </nav>
        <div class="flex items-center justify-center gap-4 mb-4 px-6">
          <button id="sidebarSettingsBtn" class="w-10 h-10" style="padding-bottom: 10px; color: var(--accent, #2563eb);">
            <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor">
              <path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/>
            </svg>
          </button>
          <button id="sidebarPrintBtn" class="w-10 h-10" style="padding-bottom: 10px; color: var(--accent, #2563eb);" onclick="window.location.href='print.html'">
            <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor">
              <path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/>
            </svg>
          </button>
        </div>
      </aside>
      <!-- Main Content -->
      <main class="flex-1 p-6 ml-64 mt-[64px]">
        <div class="container">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Print Activities</h2>
          <div id="printStatus" class="mb-4 text-red-500"></div>
          <div id="activitiesList" class="mb-6"></div>
          <div id="totalHoursSection" class="mb-4 text-xl font-bold text-blue-700 flex items-center gap-2" style="display:none;">
            Total Hours: <span id="totalHoursValue">0</span>
          </div>
          <div class="flex gap-4 mb-4">
            <button id="selectAllBtn" class="accent-btn">Select All</button>
            <button id="deselectAllBtn" class="accent-btn">Deselect All</button>
            <button id="printBtn" class="accent-btn">Print Selected</button>
          </div>
          <div class="preview" id="printPreview">
            <h3 class="text-lg font-semibold mb-2">Preview</h3>
            <button id="previewPdfBtn" class="accent-btn mb-2">Open PDF Preview in New Tab</button>
          </div>
        </div>
      </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="dashboard-theme.js"></script>
    <script>
      // Ensure the VolunteerHub theme is applied (from themes.json or backend)
      if (window.loadAndApplyDashboardTheme) {
        window.loadAndApplyDashboardTheme();
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          if (window.loadAndApplyDashboardTheme) window.loadAndApplyDashboardTheme();
        });
      }
    </script>
    <script>
      const API_URL_LOCAL = "http://localhost:3000";
      const API_URL_PROD = "https://neighborhood-liard.vercel.app";
      const API_URL = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") ? API_URL_LOCAL : API_URL_PROD;
      let lastToken = localStorage.getItem('token');
      let currentUsername = localStorage.getItem('username');
      let activities = [];
      let selectedIds = new Set();
      const activitiesList = document.getElementById('activitiesList');
      const previewContent = document.getElementById('previewContent');
      const printStatus = document.getElementById('printStatus');
      async function fetchActivities() {
        if (!currentUsername || !lastToken) {
          printStatus.textContent = 'You must be logged in to view activities.';
          return;
        }
        try {
          const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${lastToken}`,
              'Accept': 'application/json'
            }
          });
          const data = await res.json();
          activities = data.activities || [];
          renderActivitiesList();
          renderPreview();
        } catch {
          printStatus.textContent = 'Could not load activities.';
        }
      }
      function renderActivitiesList() {
        if (!activities.length) {
          activitiesList.innerHTML = '<div class="text-gray-400">No activities found.</div>';
          return;
        }
        let html = '<form id="activitiesForm">';
        activities.forEach(act => {
          const id = act.id || `${act.name}-${act.date}-${act.start_time}`;
          html += `<div class="flex items-center gap-2 mb-2">
            <input type="checkbox" class="checkbox" id="activity-${id}" data-id="${id}" ${selectedIds.has(id) ? 'checked' : ''}>
            <label for="activity-${id}" class="flex-1 cursor-pointer">
              <b>${act.name || act.title}</b> (${act.date})<br>
              ${act.start_time || ''} - ${act.end_time || ''} @ ${act.location || act.place || ''}<br>
              Supervisor: ${act.supervisorName || ''} (${act.supervisorEmail || ''})
            </label>
          </div>`;
        });
        html += '</form>';
        activitiesList.innerHTML = html;
        // Attach listeners
        document.querySelectorAll('.checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const id = this.getAttribute('data-id');
            if (this.checked) selectedIds.add(id);
            else selectedIds.delete(id);
            renderPreview();
          });
        });
      }
      function renderPreview() {
        // Calculate and show total hours for selected activities
        const totalHoursSection = document.getElementById('totalHoursSection');
        const totalHoursValue = document.getElementById('totalHoursValue');
        const selected = activities.filter(act => selectedIds.has(act.id || `${act.name}-${act.date}-${act.start_time}`));
        let total = 0;
        selected.forEach(act => {
          // Try to parse hours from act.hours, else calculate from start/end time
          if (act.hours) {
            total += parseFloat(act.hours) || 0;
          } else if (act.start_time && act.end_time) {
            const [sh, sm] = act.start_time.split(':').map(Number);
            const [eh, em] = act.end_time.split(':').map(Number);
            let diff = (eh + em/60) - (sh + sm/60);
            if (diff < 0) diff += 24; // handle overnight
            total += diff;
          }
        });
        if (selected.length) {
          totalHoursSection.style.display = '';
          totalHoursValue.textContent = total.toFixed(2);
        } else {
          totalHoursSection.style.display = 'none';
          totalHoursValue.textContent = '0';
        }
        if (!activities.length || !selectedIds.size) {
          // No preview if nothing selected
          return;
        }
        const { jsPDF } = window.jspdf;
        // Set PDF to landscape
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFont('helvetica', '');
        doc.setFontSize(18);
        doc.text('VolunteerHub Activities', 14, 18);
        doc.setFontSize(12);
        doc.text('Generated: ' + new Date().toLocaleString(), 14, 26);
        // Table head
        const head = [['#', 'Activity', 'Date', 'Time', 'Location', 'Supervisor', 'Signature']];
        // Table body with signature placeholder
        const body = selected.map((act, i) => [
          i + 1,
          act.name || act.title || '',
          act.date || '',
          `${act.start_time || ''} - ${act.end_time || ''}`,
          act.location || act.place || '',
          `${act.supervisorName || ''} (${act.supervisorEmail || ''})`,
          act.signed && act.signatureData ? '' : 'Not signed'
        ]);
        doc.autoTable({
          head,
          body,
          startY: 32,
          styles: { fontSize: 10, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] },
          alternateRowStyles: { fillColor: [240, 244, 255] },
          didDrawCell: function (data) {
            // Draw signature image in the cell if available
            if (data.column.index === 6 && data.row.index < selected.length) {
              const act = selected[data.row.index];
              if (act && act.signed && act.signatureData) {
                try {
                  const imgProps = doc.getImageProperties(act.signatureData);
                  const cellWidth = data.cell.width - 2;
                  const cellHeight = data.cell.height - 2;
                  let imgW = cellWidth, imgH = cellHeight;
                  // Maintain aspect ratio
                  if (imgProps.width / imgProps.height > cellWidth / cellHeight) {
                    imgH = imgW * imgProps.height / imgProps.width;
                  } else {
                    imgW = imgH * imgProps.width / imgProps.height;
                  }
                  // Center image in cell
                  const x = data.cell.x + (data.cell.width - imgW) / 2;
                  const y = data.cell.y + (data.cell.height - imgH) / 2;
                  doc.addImage(act.signatureData, 'PNG', x, y, imgW, imgH);
                } catch (e) {
                  doc.setFontSize(8);
                  doc.text('Invalid signature', data.cell.x + 2, data.cell.y + data.cell.height / 2);
                }
              }
            }
          }
        });
        // Add total hours below the table (reuse total from above)
        const afterTableY = doc.lastAutoTable.finalY || 32 + 10 * (body.length + 1);
        doc.setFontSize(14);
        doc.setTextColor(37, 99, 235);
        doc.text(`Total Hours: ${total.toFixed(2)}`, 14, afterTableY + 14);
        // Add footer
        const pageHeight = doc.internal.pageSize.getHeight();
        doc.setFontSize(10);
        doc.setTextColor(120);
        doc.text('VolunteerHub is an app developed by Sai Seelam.', 14, pageHeight - 10);
        // Attach PDF bloburl to preview button
        const previewBtn = document.getElementById('previewPdfBtn');
        previewBtn.onclick = function(e) {
          e.preventDefault();
          // Create a Blob and use window.open with a direct Blob URL
          const blob = doc.output('blob');
          const blobUrl = URL.createObjectURL(blob);
          // Try to open in a new tab, fallback to download if blocked
          const win = window.open(blobUrl, '_blank');
          if (!win) {
            // If popup blocked, trigger download
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = 'VolunteerHub-Activities.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        };
      }
      document.getElementById('selectAllBtn').onclick = function() {
        activities.forEach(act => selectedIds.add(act.id || `${act.name}-${act.date}-${act.start_time}`));
        renderActivitiesList();
        renderPreview();
      };
      document.getElementById('deselectAllBtn').onclick = function() {
        selectedIds.clear();
        renderActivitiesList();
        renderPreview();
      };
      document.getElementById('printBtn').onclick = function() {
        if (!selectedIds.size) {
          printStatus.textContent = 'Select at least one activity to print.';
          return;
        }
        printStatus.textContent = '';
        window.print();
      };
      fetchActivities();
    </script>
    <script>
    // Mobile redirect logic
    (function() {
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      var path = window.location.pathname;
      if (isMobile) {
        if (path.endsWith('/login.html')) window.location.replace('login.mobile.html');
        if (path.endsWith('/signup.html')) window.location.replace('signup.mobile.html');
        if (path.endsWith('/dashboard.html')) window.location.replace('dashboard.mobile.html');
        if (path.endsWith('/community.html')) window.location.replace('community.mobile.html');
        if (path.endsWith('/print.html')) window.location.replace('print.mobile.html');
      }
    })();
  </script>
</body>
</html>
