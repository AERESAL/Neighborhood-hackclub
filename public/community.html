<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolunteerHub Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { width: 75vw; height: 75vh; position: relative; margin: auto; border: 2px solid gray; background-color: rgba(200, 200, 200, 0.2); }
        header { background-color: rgba(255, 255, 255, 0.75); }
        aside { background-color: rgba(255, 255, 255, 0.75); }
        /* Update the style for .community-post-container to remove max-width and set width to 100% */
        .community-post-container {
          width: 100%;
          margin: 0 auto 18px auto;
          padding: 0;
          background: none;
          max-width: none;
        }
        .activity-card-small {
          padding: 1rem 1.2rem;
          border-radius: 0.75rem;
          box-shadow: 0 2px 8px #0001;
          border-width: 2px;
          border-color: #2563eb;
          background: #fff;
          font-size: 0.97rem;
          gap: 0.5rem;
          width: 100%;
          min-width: 0;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <!-- Header -->
    <header class="flex items-center justify-between bg-white shadow-md px-6 py-4 fixed top-0 left-0 w-full z-50">
        <h1 class="text-xl font-bold text-gray-700">VolunteerHub</h1>
        <div class="relative flex items-center gap-4">
            <!-- Profile -->
            <img src="https://i.ibb.co/xt48j1sq/1.png" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300 cursor-pointer" onclick="toggleMenu()">
            <div id="profileMenu" class="hidden absolute top-16 right-0 w-44 shadow-lg rounded-md z-50 border transition-colors">
                <ul class="py-2 text-sm" id="profileMenuList">
                    <li><a href="#" class="block px-4 py-2">Profile</a></li>
                    <li><button class="w-full text-left block px-4 py-2 text-red-600">Log Out</button></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout Wrapper -->
    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside class="w-64 h-[100vh] bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-200 shadow-md flex flex-col justify-between fixed pt-24">
            <nav class="mt-6 flex-1">
                <ul class="space-y-2">
                    <li><a href="dashboard.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Dashboard</a></li>
                    <li><a href="community.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Community</a></li>
                    <li><a href="find-activities.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Find Activities</a></li>
                </ul>
            </nav>
            <div class="flex items-center justify-center gap-4 mb-4 px-6">
                <button id="sidebarSettingsBtn" class="w-10 h-10" style="padding-bottom: 10px; color: var(--accent, #2563eb);">
                    <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor">
                      <path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/>
                    </svg>
                </button>
                <button id="sidebarPrintBtn" class="w-10 h-10" style="padding-bottom: 10px; color: var(--accent, #2563eb);" onclick="window.location.href='print.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor">
                      <path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 ml-64 relative mt-[64px]">
            <div class="bg-white bg-opacity-80 rounded-md shadow-md p-8 flex flex-col items-center justify-center" style="max-width:1000px;width:90vw;margin:0 auto;">
              <!-- Community Section -->
              <div id="communitySection">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Community</h2>
                <p class="text-gray-700 text-center">Welcome to the VolunteerHub Community page! Here you can connect with other volunteers, share your experiences, and find new opportunities to get involved.</p>
                <!-- Posts Section -->
                <section id="postsSection" class="mt-8 w-full">
                  <div class="w-full">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Posts</h3>
                    <div id="postsList" class="space-y-4">
                      <div class="bg-gray-100 rounded p-4 shadow">
                        <div class="font-bold text-lg text-gray-700">Welcome to the Community!</div>
                        <div class="text-gray-600 mt-1">Introduce yourself and share your volunteering stories here.</div>
                        <div class="text-xs text-gray-400 mt-2">VolunteerHub Team â€¢ May 29, 2025</div>
                      </div>
                    </div>
                    <form id="addPostForm" class="mt-6 flex flex-col gap-2">
                      <textarea id="postContent" class="border rounded px-3 py-2" rows="3" placeholder="Share something with the community..." required></textarea>
                      <input type="file" accept="image/*" id="postImage" class="border rounded px-3 py-2">
                      <button type="submit" class="self-end px-4 py-2 bg-blue-600 text-white rounded">Post</button>
                    </form>
                  </div>
                </section>
              </div>
              <!-- Friends Section (hidden by default) -->
              <div id="friendsSection" style="display:none;width:100%;">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Friends</h2>
                <form id="addFriendForm" class="mb-4 flex gap-2 justify-center">
                  <input type="text" id="friendSearchInput" class="border rounded px-2 py-1 flex-1 max-w-xs" placeholder="Search username..." autocomplete="off">
                  <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">Add</button>
                </form>
                <ul class="space-y-3 mb-4" id="friendsList" style="max-width:400px;margin:0 auto;"></ul>
                <div id="friendSearchResults" class="mt-2"></div>
              </div>
            </div>
        </main>
    </div>
    <video autoplay muted loop id="backgroundVideo" class="prevent-select" style="position:fixed;width:100%;height:100%;object-fit:cover;z-index:-1;top:0;left:0;"><source src="https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4" type="video/mp4"></video>
    <script src="dashboard-core.js"></script>
    <script src="dashboard-theme.js"></script>
    <script src="dashboard-ui.js"></script>
    <script>
// Apply theme color to all .themed-icon SVGs
function applyThemedIcons(color) {
  document.querySelectorAll('.themed-icon').forEach(svg => {
    svg.style.color = color;
    svg.setAttribute('fill', color);
    svg.querySelectorAll('path').forEach(path => path.setAttribute('fill', color));
  });
}
window.applyThemedIcons = applyThemedIcons;

// Force theme application after dashboard-theme.js loads
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    if (window.applyThemeFromSettings) {
      window.applyThemeFromSettings();
    } else if (window.applyTheme) {
      window.applyTheme();
    }
  }, 0);
});

const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
  ? "http://localhost:3000"
  : "https://neighborhood-liard.vercel.app";

// Render community posts
async function fetchAndRenderPosts() {
  const postsList = document.getElementById('postsList');
  postsList.innerHTML = '<div class="text-gray-400">Loading posts...</div>';
  try {
    const res = await fetch(`${API_URL}/api/community-posts`);
    if (!res.ok) throw new Error('Failed to fetch posts');
    const data = await res.json();
    console.log('Posts data:', data.posts);
    postsList.innerHTML = '';
    if (!data.posts || data.posts.length === 0) {
      postsList.innerHTML = '<div class="text-gray-400">No posts yet.</div>';
      return;
    }
    data.posts.forEach(post => {
      // If post is an activity, render as: container -> activity card (name, then userMsg, then info)
      if (post.isActivity && post.activityData) {
        const container = document.createElement('div');
        container.className = 'community-post-container';
        // Prepare user message (if any)
        let userMsg = '';
        if (post.content) {
          // Extract user message (before the 'Activity:' line)
          const lines = post.content.split('\n');
          if (lines.length > 1) {
            userMsg = lines[0].trim();
          } else if (!post.content.startsWith('Activity:')) {
            userMsg = post.content.trim();
          }
        }
        // Activity card
        const card = document.createElement('div');
        card.className = 'activity-card-small flex flex-col';
        const a = post.activityData;
        card.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <div class="font-bold text-lg text-blue-900 tracking-wide">${a.name || 'Untitled Activity'}</div>
            <div class="text-xs text-gray-400">${new Date(post.createdAt).toLocaleString()}</div>
          </div>
          ${userMsg ? `<div class='text-gray-700 text-base mb-1'>${userMsg}</div>` : ''}
          <div class="flex flex-wrap gap-4 text-gray-700 text-sm mb-1">
            <div><span class="font-semibold">Place:</span> ${a.location || '-'}</div>
            <div><span class="font-semibold">Date:</span> ${a.date || '-'}</div>
            <div><span class="font-semibold">Time:</span> ${a.start_time || '-'} - ${a.end_time || '-'}</div>
          </div>
          <div class="flex flex-wrap gap-4 text-gray-700 text-sm mb-1">
            <div><span class="font-semibold">Supervisor:</span> ${a.supervisorName || '-'}</div>
            <div><span class="font-semibold">Email:</span> <a href="mailto:${a.supervisorEmail}" class="text-blue-600 underline">${a.supervisorEmail || '-'}</a></div>
          </div>
          <div class="flex justify-end mt-2">
            <button class="join-activity-btn px-4 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-semibold shadow transition" data-id="${post.id}">Join Activity</button>
          </div>
        `;
        container.appendChild(card);
        // Author and delete button below
        const authorDiv = document.createElement('div');
        authorDiv.className = 'text-xs text-gray-500 mt-1';
        authorDiv.innerHTML = `Posted by <span class="font-semibold">${post.author || 'Anonymous'}</span>`;
        container.appendChild(authorDiv);
        if (post.author && post.author === currentUser) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-post-btn mt-2 px-3 py-1 bg-red-500 text-white rounded text-xs';
          delBtn.setAttribute('data-id', post.id);
          delBtn.textContent = 'Delete';
          container.appendChild(delBtn);
        }
        postsList.appendChild(container);
        return;
      }
      // Non-activity post: original style, but in container
      const container = document.createElement('div');
      container.className = 'community-post-container';
      const div = document.createElement('div');
      div.className = 'bg-gray-100 rounded p-4 shadow';
      let imageUrl = post.imageUrl;
      if (imageUrl && imageUrl.startsWith('/uploads/')) {
        imageUrl = `${API_URL}${imageUrl}`;
      }
      div.innerHTML = `
        <div class="font-bold text-lg text-gray-700">${post.author || 'Anonymous'}</div>
        <div class="text-gray-600 mt-1">${post.content}</div>
        ${imageUrl ? `<img src="${imageUrl}" alt="Post image" class="mt-2 max-h-60 rounded shadow" style="max-width:100%">` : ''}
        <div class="text-xs text-gray-400 mt-2">${new Date(post.createdAt).toLocaleString()}</div>
        ${post.author && post.author === currentUser ? `<button class="delete-post-btn mt-2 px-3 py-1 bg-red-500 text-white rounded text-xs" data-id="${post.id}">Delete</button>` : ''}
      `;
      container.appendChild(div);
      postsList.appendChild(container);
    });
    // Attach add-to-activities handlers
    document.querySelectorAll('.add-to-activities-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const postId = this.getAttribute('data-id');
        const post = data.posts.find(p => p.id === postId);
        if (!post || !post.activityData) return alert('No activity data found for this post.');
        // Add activity to user's activities
        const token = localStorage.getItem('token');
        if (!token) return alert('You must be logged in.');
        try {
          const res = await fetch(`${API_URL}/activities`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(post.activityData)
          });
          if (!res.ok) throw new Error('Failed to add activity');
          alert('Activity added to your activities!');
        } catch (err) {
          alert('Failed to add activity.');
        }
      });
    });
    // Attach join-activity handlers
    document.querySelectorAll('.join-activity-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const postId = this.getAttribute('data-id');
        const post = data.posts.find(p => p.id === postId);
        if (!post || !post.activityData) return alert('No activity data found for this post.');
        // Send POST to /activities endpoint
        const token = localStorage.getItem('token');
        if (!token) return alert('You must be logged in to join an activity.');
        try {
          const res = await fetch(`${API_URL}/activities`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(post.activityData)
          });
          if (!res.ok) throw new Error('Failed to join activity');
          alert('Activity added to your activities!');
        } catch (err) {
          alert('Failed to join activity.');
        }
      });
    });
    // Attach delete handlers
    document.querySelectorAll('.delete-post-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        if (!confirm('Delete this post?')) return;
        const postId = this.getAttribute('data-id');
        const username = localStorage.getItem('username') || '';
        try {
          const res = await fetch(`${API_URL}/api/community-posts/${postId}?username=${encodeURIComponent(username)}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Failed to delete');
          fetchAndRenderPosts();
        } catch (err) {
          alert('Failed to delete post.');
        }
      });
    });
  } catch (err) {
    postsList.innerHTML = '<div class="text-red-500">Failed to load posts.</div>';
  }
}

// Handle new post submission
const addPostForm = document.getElementById('addPostForm');
if (addPostForm) {
  addPostForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const postContent = document.getElementById('postContent').value.trim();
    const author = localStorage.getItem('username') || 'Anonymous';
    const imageInput = document.getElementById('postImage');
    const formData = new FormData();
    formData.append('content', postContent);
    formData.append('author', author);
    if (imageInput && imageInput.files[0]) {
      formData.append('image', imageInput.files[0]);
    }
    try {
      const res = await fetch(`${API_URL}/api/community-posts`, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error('Failed to post');
      addPostForm.reset();
      fetchAndRenderPosts();
    } catch (err) {
      alert('Failed to post.');
    }
  });
}

// Add image upload field to the form
(function addImageField() {
  const form = document.getElementById('addPostForm');
  if (form && !document.getElementById('postImage')) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.id = 'postImage';
    fileInput.className = 'border rounded px-3 py-2';
    fileInput.style.marginTop = '4px';
    form.insertBefore(fileInput, form.querySelector('button'));
  }
})();

// --- Friends Add/Search Logic (API-backed) ---
const currentUser = localStorage.getItem('username') || '';

async function fetchFriends() {
  if (!currentUser) return;
  const res = await fetch(`${API_URL}/api/friends?username=${encodeURIComponent(currentUser)}`);
  const data = await res.json();
  renderFriends(data.friends || []);
}

function renderFriends(friendsArr) {
  const ul = document.getElementById('friendsList');
  ul.innerHTML = '';
  (friendsArr || []).forEach(friend => {
    ul.innerHTML += `<li class="flex items-center gap-3"><span class="w-3 h-3 bg-green-400 rounded-full inline-block"></span> <span class="font-medium">${friend}</span></li>`;
  });
}

async function searchFriends(query) {
  if (!query) return [];
  const res = await fetch(`${API_URL}/api/friends/search?query=${encodeURIComponent(query)}&username=${encodeURIComponent(currentUser)}`);
  const data = await res.json();
  return data.users || [];
}

document.getElementById('addFriendForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const input = document.getElementById('friendSearchInput');
  const username = input.value.trim();
  if (!username) return;
  // Add friend via API
  const res = await fetch(`${API_URL}/api/friends/add`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUser, friend: username })
  });
  const data = await res.json();
  if (!res.ok) {
    alert(data.message || 'Failed to add friend');
    return;
  }
  fetchFriends();
  input.value = '';
  document.getElementById('friendSearchResults').innerHTML = '';
});

document.getElementById('friendSearchInput').addEventListener('input', async function(e) {
  const query = e.target.value.trim();
  const results = await searchFriends(query);
  const resultsDiv = document.getElementById('friendSearchResults');
  if (results.length === 0) {
    resultsDiv.innerHTML = '';
    return;
  }
  resultsDiv.innerHTML = '<div class="bg-gray-100 rounded p-2 shadow text-sm">' + results.map(name => `<div class=\"py-1 cursor-pointer hover:bg-blue-100 px-2 rounded\" onclick=\'addSearchedFriend(\"${name}\")\'>${name}</div>`).join('') + '</div>';
});

window.addSearchedFriend = async function(name) {
  // Add friend via API
  const res = await fetch(`${API_URL}/api/friends/add`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: currentUser, friend: name })
  });
  const data = await res.json();
  if (!res.ok) {
    alert(data.message || 'Failed to add friend');
    return;
  }
  fetchFriends();
  document.getElementById('friendSearchInput').value = '';
  document.getElementById('friendSearchResults').innerHTML = '';
};

fetchFriends();

// Initial load
window.addEventListener('DOMContentLoaded', fetchAndRenderPosts);

// Patch fetchAndRenderPosts to re-apply post theme after rendering
var origFetchAndRenderPosts = fetchAndRenderPosts;
fetchAndRenderPosts = async function() {
  await origFetchAndRenderPosts();
  if (window._updatePostTheme) window._updatePostTheme();
};

// --- THEME LOGIC ---
function applyCommunityTheme(theme) {
  // Header
  const header = document.querySelector('header');
  if (header) {
    header.style.background = theme.color2 || '';
    header.style.color = theme.textColor || '';
    header.querySelectorAll('h1, h2, h3, h4, h5, h6, span, p, a, button, li, div').forEach(function(el) {
      el.style.color = theme.textColor || '';
    });
  }
  // Sidebar (Friends)
  const sidebar = document.getElementById('friendsSidebar');
  if (sidebar) {
    sidebar.style.background = theme.color2 || '';
    sidebar.style.color = theme.textColor || '';
    sidebar.querySelectorAll('h1, h2, h3, h4, h5, h6, span, p, a, button, li, div').forEach(function(el) {
      el.style.color = theme.textColor || '';
    });
  }
  // Main content
  const main = document.querySelector('main');
  if (main) {
    main.querySelectorAll('h1, h2, h3, h4, h5, h6, span, p, a, button, li, div').forEach(function(el) {
      el.style.color = theme.textColor || '';
    });
  }
  // Community section background
  var communitySection = document.querySelector('main > div');
  if (communitySection) {
    communitySection.style.background = theme.color2 || '';
    communitySection.style.color = theme.textColor || '';
    communitySection.querySelectorAll('h1, h2, h3, h4, h5, h6, span, p, a, button, li, div').forEach(function(el) {
      el.style.color = theme.textColor || '';
    });
  }
  // Posts backgrounds
  function updatePostTheme() {
    var themeColor = theme.color3 || '';
    var textColor = theme.textColor || '';
    document.querySelectorAll('#postsList > div').forEach(function(div) {
      div.style.background = themeColor;
      div.style.color = textColor;
      // Also update all text inside the post
      div.querySelectorAll('*').forEach(function(el) {
        el.style.color = textColor;
        el.style.background = 'transparent';
      });
    });
  }
  updatePostTheme();
  // Also re-apply theme to posts after posts are loaded
  window._updatePostTheme = updatePostTheme;
}

function loadAndApplyCommunityTheme() {
  if (window.loadAndApplyDashboardTheme) {
    window.loadAndApplyDashboardTheme();
    return;
  }
  fetch('themes.json')
    .then(function(res) { return res.json(); })
    .then(function(data) {
      var themes = data.themes;
      var idx = localStorage.getItem('themeIdx');
      if (!idx || !themes[idx]) idx = 0;
      applyCommunityTheme(themes[idx]);
      if (window.applyThemedIcons) window.applyThemedIcons(themes[idx].textColor);
    });
}
window.addEventListener('DOMContentLoaded', loadAndApplyCommunityTheme);

// Mobile redirect logic
    (function() {
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      var path = window.location.pathname;
      if (isMobile) {
        if (path.endsWith('/login.html')) window.location.replace('login.mobile.html');
        if (path.endsWith('/signup.html')) window.location.replace('signup.mobile.html');
        if (path.endsWith('/dashboard.html')) window.location.replace('dashboard.mobile.html');
        if (path.endsWith('/community.html')) window.location.replace('community.mobile.html');
        if (path.endsWith('/print.html')) window.location.replace('print.mobile.html');
      }
    })();

    // Add Activity Post Button and Modal
(function addActivityPostFeature() {
  const addActivityPostBtn = document.createElement('button');
  addActivityPostBtn.textContent = 'Create Activity Post';
  addActivityPostBtn.className = 'px-4 py-2 bg-green-600 text-white rounded mb-2';
  const postsSection = document.getElementById('postsSection');
  if (postsSection) postsSection.insertBefore(addActivityPostBtn, postsSection.firstChild);
  addActivityPostBtn.addEventListener('click', function() {
    // Show a prompt/modal to enter activity details
    const formHtml = `
      <div id="activityPostModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
        <div class="bg-white rounded-lg shadow-lg p-6 relative w-full max-w-lg">
          <button id="closeActivityPostModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
          <form id="activityPostForm" class="space-y-4 mb-4">
            <textarea id="activityPostUserText" class="border rounded px-3 py-2 w-full" rows="2" placeholder="Add a message to your activity post (optional)"></textarea>
            <div class="flex flex-wrap gap-4">
              <input type="text" id="activityPostTitle" placeholder="Title" class="border rounded px-3 py-2 flex-1" required>
              <div style="position:relative;flex:1;">
                <input type="text" id="activityPostAddress" placeholder="Address" class="border rounded px-3 py-2 w-full" autocomplete="off" required>
                <div id="addressSuggestions" class="absolute z-10 bg-white border rounded shadow w-full" style="display:none;"></div>
              </div>
            </div>
            <div id="addressMapPreview" style="height:200px;display:none;" class="mb-2 rounded overflow-hidden"></div>
            <div class="flex flex-wrap gap-4">
              <input type="date" id="activityPostDate" class="border rounded px-3 py-2 flex-1" required>
              <input type="time" id="activityPostStartTime" class="border rounded px-3 py-2 flex-1" required>
              <input type="time" id="activityPostEndTime" class="border rounded px-3 py-2 flex-1" required>
            </div>
            <div class="flex flex-wrap gap-4">
              <input type="text" id="activityPostSupervisorName" placeholder="Supervisor Name" class="border rounded px-3 py-2 flex-1" required>
              <input type="email" id="activityPostSupervisorEmail" placeholder="Supervisor Email" class="border rounded px-3 py-2 flex-1" required>
            </div>
            <div class="flex gap-4">
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Post Activity</button>
              <button type="button" id="cancelActivityPost" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
            </div>
          </form>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', formHtml);
    // Inject Leaflet CSS/JS if not present
    if (!document.getElementById('leafletCSS')) {
      const lcss = document.createElement('link');
      lcss.rel = 'stylesheet';
      lcss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      lcss.id = 'leafletCSS';
      document.head.appendChild(lcss);
    }
    if (!document.getElementById('leafletJS')) {
      const ljs = document.createElement('script');
      ljs.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      ljs.id = 'leafletJS';
      document.body.appendChild(ljs);
    }
    const modal = document.getElementById('activityPostModal');
    const closeModal = document.getElementById('closeActivityPostModal');
    const cancelBtn = document.getElementById('cancelActivityPost');
    closeModal.onclick = cancelBtn.onclick = function() {
      modal.remove();
    };
    // --- Mapbox Address Autocomplete and Map Preview Logic ---
    let MAPBOX_API_KEY = null;
    let selectedAddress = null, selectedLatLng = null, map = null, marker = null;
    const addressInput = document.getElementById('activityPostAddress');
    const suggestionsDiv = document.getElementById('addressSuggestions');
    const mapDiv = document.getElementById('addressMapPreview');
    let addressDebounceTimer = null;
    const addressCache = {};
    addressInput.disabled = true;
    // Fetch Mapbox API key from backend
    fetch('/api/mapbox-key').then(r => r.json()).then(data => {
      MAPBOX_API_KEY = data.key;
      addressInput.disabled = false;
    }).catch(() => {
      suggestionsDiv.innerHTML = '<div class="px-2 py-2 text-red-600">Failed to load Mapbox API key.</div>';
      suggestionsDiv.style.display = 'block';
    });
    addressInput.addEventListener('input', function() {
      const q = addressInput.value.trim();
      if (addressDebounceTimer) clearTimeout(addressDebounceTimer);
      if (!q || q.length < 3) { suggestionsDiv.style.display = 'none'; return; }
      addressDebounceTimer = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="px-2 py-2 text-gray-500">Searching...</div>';
        suggestionsDiv.style.display = 'block';
        if (addressCache[q]) {
          renderAddressSuggestions(addressCache[q]);
          return;
        }
        if (!MAPBOX_API_KEY) {
          suggestionsDiv.innerHTML = '<div class="px-2 py-2 text-red-600">Mapbox key not loaded.</div>';
          suggestionsDiv.style.display = 'block';
          return;
        }
        // Mapbox Geocoding API
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_API_KEY}&autocomplete=true&limit=5`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          addressCache[q] = data.features || [];
          renderAddressSuggestions(data.features || []);
        } catch {
          suggestionsDiv.innerHTML = '<div class="px-2 py-2 text-red-600">Error searching for addresses.</div>';
          suggestionsDiv.style.display = 'block';
        }
      }, 400);
    });
    function renderAddressSuggestions(features) {
      if (!features.length) { suggestionsDiv.innerHTML = '<div class="px-2 py-2 text-gray-500">No results found.</div>'; suggestionsDiv.style.display = 'block'; return; }
      suggestionsDiv.innerHTML = features.map(item => {
        const label = item.place_name || item.text || 'Unknown';
        return `<div class='px-2 py-1 hover:bg-blue-100 cursor-pointer' data-lat='${item.center[1]}' data-lon='${item.center[0]}' data-display='${label.replace(/'/g, "&apos;")}' >${label}</div>`;
      }).join('');
      suggestionsDiv.style.display = 'block';
      Array.from(suggestionsDiv.children).forEach(child => {
        child.onclick = function() {
          addressInput.value = this.getAttribute('data-display');
          selectedAddress = this.getAttribute('data-display');
          selectedLatLng = [parseFloat(this.getAttribute('data-lat')), parseFloat(this.getAttribute('data-lon'))];
          suggestionsDiv.style.display = 'none';
          showMapPreview(selectedLatLng, selectedAddress);
        };
      });
    }
    addressInput.addEventListener('blur', function() {
      setTimeout(() => { suggestionsDiv.style.display = 'none'; }, 150);
      setTimeout(() => { mapDiv.style.display = 'none'; }, 200);
    });
    addressInput.addEventListener('focus', function() {
      if (selectedLatLng) mapDiv.style.display = 'block';
    });
    function showMapPreview(latlng, label) {
      mapDiv.style.display = 'block';
      setTimeout(() => {
        if (!window.L) return;
        if (!map) {
          map = L.map(mapDiv).setView(latlng, 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
        } else {
          map.setView(latlng, 15);
        }
        if (marker) marker.remove();
        marker = L.marker(latlng).addTo(map).bindPopup(label).openPopup();
      }, 100);
    }
    if (!window.L) {
      const checkLeaflet = setInterval(() => {
        if (window.L) {
          clearInterval(checkLeaflet);
        }
      }, 50);
    }
    document.getElementById('activityPostForm').onsubmit = async function(e) {
      e.preventDefault();
      const author = localStorage.getItem('username') || 'Anonymous';
      const userText = document.getElementById('activityPostUserText').value.trim();
      const activityData = {
        name: document.getElementById('activityPostTitle').value.trim(),
        date: document.getElementById('activityPostDate').value,
        start_time: document.getElementById('activityPostStartTime').value,
        end_time: document.getElementById('activityPostEndTime').value,
        location: addressInput.value.trim(),
        supervisorName: document.getElementById('activityPostSupervisorName').value.trim(),
        supervisorEmail: document.getElementById('activityPostSupervisorEmail').value.trim(),
        approved: false
      };
      if (!selectedLatLng) {
        alert('Please select a valid address from the suggestions.');
        return;
      }
      // Post to community as an activity
      const formData = new FormData();
      let content = userText ? userText + '\n' : '';
      content += `Activity: ${activityData.name} @ ${activityData.location} on ${activityData.date}`;
      formData.append('content', content);
      formData.append('author', author);
      formData.append('isActivity', 'true');
      formData.append('activityData', JSON.stringify(activityData));
      try {
        const res = await fetch(`${API_URL}/api/community-posts`, {
          method: 'POST',
          body: formData
        });
        if (!res.ok) throw new Error('Failed to post activity');
        modal.remove();
        fetchAndRenderPosts();
      } catch (err) {
        alert('Failed to post activity.');
      }
    };
  });
})();
  </script>
</body>
</html>
