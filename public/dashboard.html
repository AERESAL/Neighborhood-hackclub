<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolunteerHub Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container {
            width: 75vw;
            height: 75vh;
            position: relative;
            margin: auto;
            border: 2px solid gray;
            background-color: rgba(200, 200, 200, 0.2);
        }

        .widget {
            width: 25vw;
            height: 25vh;
            background: rgba(0, 0, 0, 0.7); /* Increase transparency */
            color: white; /* Ensure text is visible on dark background */
            text-align: center;
            font-size: 1.2rem;
            position: absolute;
            border-radius: 10px;
            cursor: grab;
            resize: none;
            overflow: auto;
            min-width: 180px;
            min-height: 120px;
            max-width: 100%;
            max-height: 100%;
        }

        .editing .widget {
            cursor: move;
            resize: both;
        }

        .editing .widget.corner-indicator {
            position: relative;
        }
.editing .widget::after,
.editing .widget::before,
.editing .widget .corner-br {
    position: absolute;
    pointer-events: none;
    z-index: 10;
    background: none;
    display: none;
}
.editing .widget .corner-br { right: 0; bottom: 0; display: block; }

.editing .widget .corner-br::before,
.editing .widget .corner-br::after {
    content: '';
    position: absolute;
    background: white;
}
.editing .widget .corner-br::before {
    right: 0; bottom: 0;
    width: 26px; height: 7px;
    border-bottom-right-radius: 24px 24px;
}
.editing .widget .corner-br::after {
    right: 0; bottom: 0;
    width: 7px; height: 26px;
    border-bottom-right-radius: 24px 24px;
}

        #widget1 {
            top: 0;
            left: 0;
        }

        #widget2 {
            top: 0;
            right: 0;
        }

        #widget3 {
            bottom: 0;
            left: 0;
        }

        #widget4 {
            bottom: 0;
            right: 0;
        }

        #backgroundVideo {
            position: fixed;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }

        header {
            background-color: rgba(255, 255, 255, 0.75); /* 75% transparency */
        }

        aside {
            background-color: rgba(255, 255, 255, 0.75); /* 75% transparency */
        }
        .prevent-select {
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10 and IE 11 */
        user-select: none; /* Standard syntax */
        }
        .widget, .widget * {
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <script>
  // Redirect to login if not authenticated
  (function() {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }
  })();
</script>

    <!-- Background Video -->
    <video autoplay muted loop id="backgroundVideo" class="prevent-select">
        <source src="https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4" type="video/mp4">
    </video>

    <!-- Header -->
    <header class="flex items-center justify-between bg-white shadow-md px-6 py-4 fixed top-0 left-0 w-full z-50">
        <h1 class="text-xl font-bold text-gray-700">VolunteerHub</h1>
        <div class="relative flex items-center gap-4">
            <!-- Profile -->
            <img src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300 cursor-pointer" onclick="toggleMenu()">
            <div id="profileMenu" class="hidden absolute top-16 right-0 w-44 shadow-lg rounded-md z-50 border transition-colors">
                <ul class="py-2 text-sm" id="profileMenuList">
                    <li><a href="#" class="block px-4 py-2">Profile</a></li>
                    <li><button class="w-full text-left block px-4 py-2 text-red-600">Log Out</button></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout Wrapper -->
    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside class="w-64 h-[100vh] bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-200 shadow-md flex flex-col justify-between fixed pt-24">
            <nav class="mt-6 flex-1">
                <ul class="space-y-2">
                    <li><a href="#" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Activities</a></li>
                    <li><a href="#" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Leaderboard</a></li>
                    <li><a href="#" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">My Hours</a></li>
                </ul>
            </nav>

            <div class="flex items-center justify-center gap-4 mb-4 px-6">
                <button id="sidebarSettingsBtn" class="w-10 h-10 text-gray-600 hover:text-gray-800" style="padding-bottom: 10px;">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#ffffff"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
                </button>
                <button id="sidebarPrintBtn" class="w-10 h-10 text-gray-600 hover:text-gray-800" style="padding-bottom: 10px;">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#e3e3e3"><path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/></svg>
                </button>
            </div>
        </aside>
        

        <!-- Main Content with Movable Widgets -->
        <main class="flex-1 p-6 ml-64 relative mt-[64px]">
            <!-- Greeting Container -->
            <div class="bg-black bg-opacity-50 text-white p-6 rounded-md shadow-md relative">
                <button id="editButton" class="absolute top-4 right-4 p-2 rounded-full transition-colors" title="Edit Widgets" style="background: var(--accent, #2563eb);">
                  <svg id="editIcon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h357l-80 80H200v560h560v-278l80-80v358q0 33-23.5 56.5T760-120H200Zm280-360ZM360-360v-170l367-367q12-12 27-18t30-6q16 0 30.5 6t26.5 18l56 57q11 12 17 26.5t6 29.5q0 15-5.5 29.5T897-728L530-360H360Zm481-424-56-56 56 56ZM440-440h56l232-232-28-28-29-28-231 231v57Zm260-260-29-28 29 28 28 28-28-28Z"/></svg>
                </button>
                <h1 id="greeting" class="text-3xl font-bold"></h1>
                <p id="currentDate" class="text-lg mt-2"></p>
            </div>

            <!-- Movable Widgets -->
        <!-- Movable Container -->
        <div class="container" id="container">
            <!-- Movable Widgets -->
            <div class="widget bg-black bg-opacity-25 text-white flex flex-col items-center justify-center select-none" id="widget1" style="user-select: none;">
  <div class="corner-br"></div>
  <div class="text-lg font-semibold mb-1">Approved Hours</div>
  <div id="approvedHours" class="text-3xl font-bold">0</div>
  <div class="text-sm mt-1">Signed Activities</div>
  <div id="approvedActivities" class="text-xl font-semibold">0</div>
</div>
            <div class="widget bg-black bg-opacity-25 text-white flex flex-col items-center justify-center select-none" id="widget2" style="user-select: none;">
  <div class="corner-br"></div>
  <div class="text-lg font-semibold mb-1">Unapproved Hours</div>
  <div id="unapprovedHours" class="text-3xl font-bold">0</div>
  <div class="text-sm mt-1">Unapproved Activities</div>
  <div id="unapprovedActivities" class="text-xl font-semibold">0</div>
</div>
            <div class="widget bg-black bg-opacity-25 text-white" id="widget3">
  <div class="corner-br"></div>
  Widget 3
</div>
            <div class="widget bg-black bg-opacity-25 text-white" id="widget4">
  <div class="corner-br"></div>
  Widget 4
</div>
        </div>

        <!-- Activities Section -->
        <section id="activitiesSection" class="mt-12 bg-white bg-opacity-80 rounded-md shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Activities</h2>
                <button id="addActivityBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Add Activity</button>
            </div>
            <form id="addActivityForm" class="space-y-4 mb-4 hidden">
                <div class="flex flex-wrap gap-4">
                    <input type="text" id="activityTitle" placeholder="Title" class="border rounded px-3 py-2 flex-1" required>
                    <input type="text" id="activityPlace" placeholder="Place" class="border rounded px-3 py-2 flex-1" required>
                </div>
                <div class="flex flex-wrap gap-4">
                    <input type="date" id="activityDate" class="border rounded px-3 py-2 flex-1" required>
                    <input type="time" id="activityStartTime" class="border rounded px-3 py-2 flex-1" required>
                    <input type="time" id="activityEndTime" class="border rounded px-3 py-2 flex-1" required>
                </div>
                <div class="flex flex-wrap gap-4">
                    <input type="text" id="supervisorName" placeholder="Supervisor Name" class="border rounded px-3 py-2 flex-1" required>
                    <input type="email" id="supervisorEmail" placeholder="Supervisor Email" class="border rounded px-3 py-2 flex-1" required>
                </div>
                <div class="flex items-center mb-2">
                    <input type="checkbox" id="getSignatureCheckbox" class="mr-2">
                    <label for="getSignatureCheckbox" class="text-gray-700">Get a Signature (email supervisor)</label>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Submit</button>
                    <button type="button" id="cancelAddActivity" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
                </div>
            </form>
            <div id="activityStatus" class="mb-4"></div>
            <div id="activitiesList"></div>
            <button id="printActivitiesBtn" style="margin:20px 0; display:none;" class="px-4 py-2 bg-purple-600 text-white rounded-md">Print Activities PDF</button>
        </section>
        <!-- End Activities Section -->

        <!-- Leaderboard Section -->
        <section id="leaderboardSection" class="mt-12 bg-white bg-opacity-80 rounded-md shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Leaderboard</h2>
            </div>
            <div id="leaderboardStatus" class="mb-4"></div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volunteer</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved Hours</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center text-gray-400 py-4">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        <!-- End Leaderboard Section -->
        </main>
    </div>

    <script>
        // --- Redirect to login if not authenticated ---
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            }
        })();

        // --- JWT decode helper ---
        function parseJwt (token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }
        // Try to get token from localStorage
        let token = localStorage.getItem('token');
        let userName = "Please log in";
        if (token) {
            const decoded = parseJwt(token);
            if (decoded && decoded.username) {
                userName = decoded.username;
            }
        }
        window.userName = userName;

        const greetings = [
            `Hello, ${userName}!`,
            `Welcome, ${userName}!`,
            `Hi there, ${userName}!`,
            `Good to see you, ${userName}!`,
            `Hey, ${userName}!`
        ];
        document.getElementById("greeting").innerText = greetings[Math.floor(Math.random() * greetings.length)];
        document.getElementById("currentDate").innerText = new Date().toDateString();

        function toggleMenu() {
            const menu = document.getElementById("profileMenu");
            menu.classList.toggle("hidden");
        }

        document.addEventListener('click', function(e) {
            const settingsMenu = document.getElementById('settingsMenu');
            if (settingsMenu && !settingsMenu.classList.contains('hidden')) {
                if (!settingsMenu.contains(e.target) && e.target.textContent !== 'Settings') {
                    settingsMenu.classList.add('hidden');
                }
            }
        });

        let isEditing = false;
        const editButton = document.getElementById("editButton");
        const editIcon = document.getElementById("editIcon");
        const container = document.getElementById("container");

        // Fetch accent color from themes.json and apply to edit button
        function applyEditButtonAccent() {
          const themeIdx = getCookie('themeIdx');
          if (themeIdx !== undefined) {
            fetch('./themes.json')
              .then(res => res.json())
              .then(data => {
                const themes = data.themes;
                if (themes[themeIdx] && themes[themeIdx].accents) {
                  editButton.style.background = themes[themeIdx].accents;
                }
              });
          }
        }
        applyEditButtonAccent();

        editButton.addEventListener("click", () => {
          isEditing = !isEditing;
          container.classList.toggle("editing", isEditing);
          if (isEditing) {
            editButton.classList.add('ring-4', 'ring-white');
          } else {
            editButton.classList.remove('ring-4', 'ring-white');
          }
        });

        // Ensure the container is not moveable
        container.style.position = "relative";

        // --- Widget Drag & Resize Logic ---
document.querySelectorAll('.widget').forEach(widget => {
    // Remove JS that creates/toggles corner indicators
    widget.addEventListener('mousedown', (event) => {
        // Prevent drag if resizing (on resize handle)
        if (!isEditing || event.target.classList.contains('widget-resize-handle')) return;
        // Prevent drag if resizing (on native resize handle)
        if (isEditing && (event.offsetX > widget.clientWidth - 20 && event.offsetY > widget.clientHeight - 20)) return;
        let offsetX = event.clientX - widget.offsetLeft;
        let offsetY = event.clientY - widget.offsetTop;
        let isResizing = false;
        function moveWidget(e) {
            if (isResizing) return;
            let newLeft = e.clientX - offsetX;
            let newTop = e.clientY - offsetY;
            // Constrain movement within the container
            const containerRect = container.getBoundingClientRect();
            const widgetRect = widget.getBoundingClientRect();
            if (newLeft < 0) newLeft = 0;
            if (newTop < 0) newTop = 0;
            if (newLeft + widgetRect.width > containerRect.width) newLeft = containerRect.width - widgetRect.width;
            if (newTop + widgetRect.height > containerRect.height) newTop = containerRect.height - widgetRect.height;
            // Check for collisions with other widgets
            const widgets = document.querySelectorAll('.widget');
            let collision = false;
            widgets.forEach(otherWidget => {
                if (otherWidget === widget) return;
                const otherRect = otherWidget.getBoundingClientRect();
                if (
                    newLeft < otherRect.right - containerRect.left &&
                    newLeft + widgetRect.width > otherRect.left - containerRect.left &&
                    newTop < otherRect.bottom - containerRect.top &&
                    newTop + widgetRect.height > otherRect.top - containerRect.top
                ) {
                    collision = true;
                }
            });
            if (!collision) {
                widget.style.left = `${newLeft}px`;
                widget.style.top = `${newTop}px`;
            }
        }
        function stopMove() {
            document.removeEventListener('mousemove', moveWidget);
            document.removeEventListener('mouseup', stopMove);
        }
        document.addEventListener('mousemove', moveWidget);
        document.addEventListener('mouseup', stopMove);
    });
    // Prevent moving while resizing
    widget.addEventListener('mousedown', (event) => {
        if (!isEditing) return;
        // If mouse is on the resize handle (bottom-right corner), don't allow move
        if (event.offsetX > widget.clientWidth - 20 && event.offsetY > widget.clientHeight - 20) {
            event.stopPropagation();
        }
    });
});

        // Remove theme switcher button event and element
        const themeSwitcher = document.getElementById('themeSwitcher');
        if (themeSwitcher) themeSwitcher.remove();
        // Sidebar settings and print button functionality
        document.getElementById('sidebarSettingsBtn').onclick = function() {
            window.location.href = 'settings.html';
        };
        document.getElementById('sidebarPrintBtn').onclick = function() {
            document.getElementById('printActivitiesBtn').click();
        };

        // --- Theme selection logic ---
        function applyTheme(theme) {
            const header = document.querySelector('header');
            const sidebar = document.querySelector('aside');
            const backgroundVideo = document.getElementById('backgroundVideo');
            if (theme === 'dark') {
                document.body.classList.add('dark');
                header.classList.add('dark:bg-gray-800', 'dark:text-gray-200');
                sidebar.classList.add('dark:bg-gray-800', 'dark:text-gray-200');
                backgroundVideo.src = 'https://cdn.pixabay.com/video/2025/04/07/270507_large.mp4';
            } else {
                document.body.classList.remove('dark');
                header.classList.remove('dark:bg-gray-800', 'dark:text-gray-200');
                sidebar.classList.remove('dark:bg-gray-800', 'dark:text-gray-200');
                backgroundVideo.src = 'https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4';
            }
        }

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function setTheme(theme) {
            if (theme === 'system') {
                theme = getSystemTheme();
            }
            applyTheme(theme);
            localStorage.setItem('theme', theme);
        }

        // Listen for theme option clicks
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.addEventListener('click', function() {
                const selected = this.getAttribute('data-theme');
                if (selected === 'system') {
                    localStorage.setItem('theme', 'system');
                    setTheme('system');
                } else {
                    setTheme(selected);
                }
            });
        });

        // Apply saved or system theme on page load
        let savedTheme = localStorage.getItem('theme');
        if (!savedTheme) savedTheme = 'system';
        if (savedTheme === 'system') {
            setTheme('system');
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (localStorage.getItem('theme') === 'system') setTheme('system');
            });
        } else {
            setTheme(savedTheme);
        }

        // --- Theme from cookies helper ---
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        function applyDashboardTheme(theme) {
            // Set background video or image
            let bgMedia = document.getElementById('backgroundVideo');
            if (theme.background.endsWith('.mp4')) {
                if (!bgMedia || bgMedia.tagName !== 'VIDEO') {
                    if (bgMedia) bgMedia.remove();
                    bgMedia = document.createElement('video');
                    bgMedia.id = 'backgroundVideo';
                    bgMedia.className = 'prevent-select fixed top-0 left-0 w-full h-full object-cover -z-10';
                    bgMedia.autoplay = true;
                    bgMedia.loop = true;
                    bgMedia.muted = true;
                    bgMedia.playsInline = true;
                    document.body.prepend(bgMedia);
                }
                bgMedia.src = theme.background;
            } else {
                if (!bgMedia || bgMedia.tagName !== 'IMG') {
                    if (bgMedia) bgMedia.remove();
                    bgMedia = document.createElement('img');
                    bgMedia.id = 'backgroundVideo';
                    bgMedia.className = 'prevent-select fixed top-0 left-0 w-full h-full object-cover -z-10';
                    document.body.prepend(bgMedia);
                }
                bgMedia.src = theme.background;
            }
            // Apply text and accent colors
            document.body.style.color = theme.textColor;
            const header = document.querySelector('header');
            const sidebar = document.querySelector('aside');
            if (header) header.style.background = theme.color2;
            if (sidebar) sidebar.style.background = theme.color2;
            // --- Activities Section Theming ---
            const activitiesSection = document.getElementById('activitiesSection');
            if (activitiesSection) {
                activitiesSection.style.background = theme.color2;
                activitiesSection.style.color = theme.textColor;
                activitiesSection.style.borderColor = theme.accents;
            }
            // Style activities section title and buttons
            const activitiesTitle = activitiesSection ? activitiesSection.querySelector('h2') : null;
            if (activitiesTitle) activitiesTitle.style.color = theme.accents;
            const addActivityBtn = document.getElementById('addActivityBtn');
            if (addActivityBtn) {
                addActivityBtn.style.background = theme.accents;
                addActivityBtn.style.color = theme.textColor;
                addActivityBtn.style.border = `1.5px solid ${theme.accents}`;
            }
            const printBtn = document.getElementById('printActivitiesBtn');
            if (printBtn) {
                printBtn.style.background = theme.accents;
                printBtn.style.color = theme.textColor;
                printBtn.style.border = `1.5px solid ${theme.accents}`;
            }
            // Style activity cards and signature buttons
            const activityCards = document.querySelectorAll('#activitiesList > div');
            activityCards.forEach(card => {
                card.style.background = theme.color3;
                card.style.color = theme.textColor;
                card.style.border = `1.5px solid ${theme.accents}`;
            });
            const sigBtns = document.querySelectorAll('.get-signature-btn');
            sigBtns.forEach(btn => {
                btn.style.background = theme.accents;
                btn.style.color = theme.textColor;
                btn.style.border = `1.5px solid ${theme.accents}`;
            });
        }
        // On load, fetch theme from cookie and apply
        (function() {
            const themeIdx = getCookie('themeIdx');
            if (themeIdx !== undefined) {
                fetch('./themes.json')
                  .then(res => res.json())
                  .then(data => {
                    const themes = data.themes;
                    if (themes[themeIdx]) {
                        applyDashboardTheme(themes[themeIdx]);
                    }
                  });
            }
        })();

        // Activities Section Script
        const addActivityBtn = document.getElementById('addActivityBtn');
        const addActivityForm = document.getElementById('addActivityForm');
        const activitiesList = document.getElementById('activitiesList');
        const cancelAddActivity = document.getElementById('cancelAddActivity');

        // --- Activities Section Logic (from servertest.html, adapted) ---
const API_URL_LOCAL = "http://localhost:3000";
const API_URL_PROD = "https://neighborhood-liard.vercel.app";
const API_URL = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost")
  ? API_URL_LOCAL
  : API_URL_PROD;

let lastToken = localStorage.getItem('token');
let currentUsername = window.userName;

async function fetchAndRenderActivities() {
  if (!currentUsername || !lastToken) return;
  const activitiesList = document.getElementById('activitiesList');
  activitiesList.innerHTML = '<div class="text-gray-500">Loading...</div>';
  try {
    const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${lastToken}`,
        'Accept': 'application/json'
      },
      credentials: 'include'
    });
    const data = await res.json();
    const activities = data.activities || [];
    renderActivitiesSection(activities);
  } catch {
    activitiesList.innerHTML = '<div class="text-red-500">Could not load activities.</div>';
  }
}

        function renderActivitiesSection(activities) {
  const activitiesList = document.getElementById('activitiesList');
  let html = '';
  if (activities.length > 0) {
    activities.forEach((activity, idx) => {
      html += `<div class='mb-4 p-4 bg-gray-100 rounded-md shadow-md'>`;
      html += `<div><strong>Name:</strong> ${activity.name || activity.title || ''}</div>`;
      html += `<div><strong>Date:</strong> ${activity.date || activity.activityDate || ''}</div>`;
      html += `<div><strong>Start Time:</strong> ${activity.start_time || activity.startTime || ''}</div>`;
      html += `<div><strong>End Time:</strong> ${activity.end_time || activity.endTime || ''}</div>`;
      html += `<div><strong>Location:</strong> ${activity.location || activity.place || ''}</div>`;
      html += `<div><strong>Supervisor:</strong> ${activity.supervisorName || ''} (${activity.supervisorEmail || ''})</div>`;
      if (activity.signed && activity.signatureData) {
        html += `<div><strong>Signature:</strong><br><img src="${activity.signatureData}" alt="Signature" style="height:40px;vertical-align:middle;"></div>`;
      } else {
        html += `<div><strong>Signature:</strong> Not signed</div>`;
        html += `<button class="get-signature-btn px-3 py-1 bg-blue-500 text-white rounded mt-2" data-idx="${idx}">Get Signature</button>`;
      }
      html += `</div>`;
    });
    document.getElementById("printActivitiesBtn").style.display = "inline-block";
  } else {
    html += `<div class='text-gray-500'>No activities found.</div>`;
    document.getElementById("printActivitiesBtn").style.display = "none";
  }
  activitiesList.innerHTML = html;

  // Add event listeners for Get Signature buttons
  document.querySelectorAll('.get-signature-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const idx = parseInt(this.getAttribute('data-idx'));
      const activity = activities[idx];
      const activityStatus = document.getElementById('activityStatus');
      activityStatus.textContent = 'Sending signature request...';
      activityStatus.style.color = '#333';
      try {
        const res = await fetch(`${API_URL}/send-signature-request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${lastToken}`
          },
          body: JSON.stringify({
            name: activity.name || activity.title || '',
            date: activity.date || activity.activityDate || '',
            start_time: activity.start_time || activity.startTime || '',
            end_time: activity.end_time || activity.endTime || '',
            location: activity.location || activity.place || '',
            supervisorName: activity.supervisorName || '',
            supervisorEmail: activity.supervisorEmail || ''
          })
        });
        const data = await res.json();
        if (!res.ok) {
          activityStatus.textContent = `Failed to send signature request: ${data.message || 'Unknown error.'}`;
          activityStatus.style.color = '#e74c3c';
        } else {
          activityStatus.textContent = 'Signature request sent to supervisor!';
          activityStatus.style.color = '#27ae60';
          await fetchAndRenderActivities();
        }
      } catch (err) {
        activityStatus.textContent = 'Error sending signature request.';
        activityStatus.style.color = '#e74c3c';
      }
    });
  });

  // Re-apply theme to new activity cards/buttons
  const themeIdx = getCookie('themeIdx');
  if (themeIdx !== undefined) {
    fetch('./themes.json')
      .then(res => res.json())
      .then(data => {
        const themes = data.themes;
        if (themes[themeIdx]) {
          applyDashboardTheme(themes[themeIdx]);
        }
      });
  }
}

document.getElementById("printActivitiesBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });
  const logoImg = '';
  if (logoImg) {
    doc.addImage(logoImg, "PNG", 10, 5, 40, 20);
  }
  let y = logoImg ? 30 : 15;
  doc.setFontSize(22);
  doc.text("VolunteerHub Volunteer Hours", 80, y);
  y += 12;
  let volunteerName = currentUsername;
  try {
    const userRes = await fetch(`${API_URL}/users`, {
      method: "GET",
      headers: { "Authorization": `Bearer ${lastToken}` }
    });
    const userData = await userRes.json();
    if (userData.firstName || userData.lastName) {
      volunteerName = `${userData.firstName || ""} ${userData.lastName || ""}`.trim();
    }
  } catch {}
  doc.setFontSize(14);
  doc.text(`Volunteer: ${volunteerName}`, 14, y);
  y += 8;
  const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
    method: "GET",
    headers: {
      "Authorization": `Bearer ${lastToken}`,
      "Accept": "application/json"
    }
  });
  const data = await res.json();
  const activities = data.activities || [];
  const tableBody = activities.map(act => [
    act.name || act.title || "",
    act.date || act.activityDate || "",
    act.supervisorName || "",
    act.location || act.place || "",
    ""
  ]);
  doc.autoTable({
    startY: y + 5,
    head: [["Activity Name", "Date", "Supervisor", "Organization/Location", "Signature"]],
    body: tableBody,
    theme: "grid",
    styles: { fontSize: 12, cellPadding: 3, minCellHeight: 15 },
    columnStyles: {
      0: { cellWidth: 50 },
      1: { cellWidth: 30 },
      2: { cellWidth: 40 },
      3: { cellWidth: 50 },
      4: { cellWidth: 50 }
    },
    didDrawCell: function (data) {
      if (data.column.index === 4) {
        const act = activities[data.row.index];
        if (act && act.signed && act.signatureData) {
          doc.addImage(
            act.signatureData,
            "PNG",
            data.cell.x + 2,
            data.cell.y + 2,
            40,
            15
          );
        } else if (act && !act.signed) {
          doc.setFontSize(10);
          doc.text("Not signed", data.cell.x + 5, data.cell.y + 12);
        }
      }
    }
  });
  doc.save("volunteer_hours.pdf");
});

        // Fetch and display activities from Firestore
        async function loadActivities() {
            activitiesList.innerHTML = '<li class="text-gray-500">Loading...</li>';
            try {
                const res = await fetch('/get-activities', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                if (!res.ok) throw new Error('Failed to fetch activities');
                const data = await res.json();
                activitiesList.innerHTML = '';
                if (data.activities && data.activities.length > 0) {
                    data.activities.forEach(activity => {
                        const activityItem = document.createElement('li');
                        activityItem.className = 'p-4 bg-gray-100 rounded-md shadow-md';
                        activityItem.innerHTML = `
                            <h3 class="font-semibold text-gray-800">${activity.title}</h3>
                            <p class="text-gray-600">${activity.place}</p>
                            <p class="text-gray-500 text-sm font-bold">${activity.activityDate}</p>
                            <p class="text-gray-500 text-sm">From: ${activity.startTime} To: ${activity.endTime}</p>
                            <p class="text-gray-500 text-sm">Supervisor: ${activity.supervisorName} (${activity.supervisorEmail})</p>
                        `;
                        activitiesList.appendChild(activityItem);
                    });
                } else {
                    activitiesList.innerHTML = '<li class="text-gray-500">No activities yet.</li>';
                }
            } catch (err) {
                activitiesList.innerHTML = '<li class="text-red-500">Error loading activities.</li>';
            }
        }

        addActivityBtn.addEventListener('click', () => {
            addActivityForm.classList.toggle('hidden');
        });

        cancelAddActivity.addEventListener('click', () => {
            addActivityForm.classList.add('hidden');
        });

        addActivityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('activityTitle').value;
            const place = document.getElementById('activityPlace').value;
            const activityDate = document.getElementById('activityDate').value;
            const startTime = document.getElementById('activityStartTime').value;
            const endTime = document.getElementById('activityEndTime').value;
            const supervisorName = document.getElementById('supervisorName').value;
            const supervisorEmail = document.getElementById('supervisorEmail').value;
            const activity = {
                name: title,
                date: activityDate,
                start_time: startTime,
                end_time: endTime,
                location: place,
                supervisorName,
                supervisorEmail
            };
            const getSignature = document.getElementById('getSignatureCheckbox').checked;
            try {
                const res = await fetch(`${API_URL}/activities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(lastToken ? { 'Authorization': `Bearer ${lastToken}` } : {})
                    },
                    body: JSON.stringify(activity)
                });
                if (!res.ok) throw new Error('Failed to add activity');
                if (getSignature) {
                    const sigRes = await fetch(`${API_URL}/send-signature-request`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${lastToken}`
                        },
                        body: JSON.stringify(activity)
                    });
                    const sigData = await sigRes.json();
                    if (!sigRes.ok) {
                        document.getElementById('activityStatus').textContent = `Activity added, but failed to send signature email: ${sigData.message}`;
                        document.getElementById('activityStatus').style.color = '#e74c3c';
                    } else {
                        document.getElementById('activityStatus').textContent = 'Activity added and signature request sent!';
                        document.getElementById('activityStatus').style.color = '#27ae60';
                    }
                } else {
                    document.getElementById('activityStatus').textContent = 'Activity added successfully!';
                    document.getElementById('activityStatus').style.color = '#27ae60';
                }
                addActivityForm.reset();
                addActivityForm.classList.add('hidden');
                await fetchAndRenderActivities();
                updateApprovedWidget();
                updateUnapprovedWidget();
            } catch (err) {
                document.getElementById('activityStatus').textContent = 'Error adding activity.';
                document.getElementById('activityStatus').style.color = '#e74c3c';
            }
        });

        // Load activities on page load
        fetchAndRenderActivities();

        // Log Out button functionality
        const logoutBtn = document.querySelector('#profileMenu button');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            });
        }
        // Ensure Log Out button always works, even if menu is hidden at load
function handleLogoutClick(e) {
    if (e.target.matches('#profileMenu .text-red-600')) {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }
}
document.getElementById('profileMenu').addEventListener('click', handleLogoutClick);
// --- Theme application for profile menu ---
function applyProfileMenuTheme(theme) {
    const profileMenu = document.getElementById('profileMenu');
    const profileMenuList = document.getElementById('profileMenuList');
    if (!profileMenu || !profileMenuList) return;
    profileMenu.style.background = theme.color2;
    profileMenu.style.color = theme.textColor;
    profileMenu.style.borderColor = theme.accents;
    profileMenuList.querySelectorAll('a, button').forEach(el => {
        el.style.color = theme.textColor;
        el.style.background = 'transparent';
        el.onmouseover = function() { this.style.background = theme.color3; };
        el.onmouseout = function() { this.style.background = 'transparent'; };
    });
}
// Patch applyDashboardTheme to also update profile menu
const origApplyDashboardTheme = applyDashboardTheme;
applyDashboardTheme = function(theme) {
    origApplyDashboardTheme(theme);
    applyProfileMenuTheme(theme);
};
// On load, also apply to profile menu if themeIdx is set
(function() {
    const themeIdx = getCookie('themeIdx');
    if (themeIdx !== undefined) {
        fetch('./themes.json')
          .then(res => res.json())
          .then(data => {
            const themes = data.themes;
            if (themes[themeIdx]) {
                applyProfileMenuTheme(themes[themeIdx]);
            }
          });
    }
})();

async function updateApprovedWidget() {
  let approvedCount = 0;
  let approvedHours = 0;
  try {
    const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${lastToken}`,
        'Accept': 'application/json'
      },
      credentials: 'include'
    });
    const data = await res.json();
    const activities = data.activities || [];
    activities.forEach(act => {
      if (act.signed) {
        approvedCount++;
        // Calculate hours (if start/end time available)
        let start = act.start_time || act.startTime;
        let end = act.end_time || act.endTime;
        if (start && end) {
          const [sh, sm] = start.split(":").map(Number);
          const [eh, em] = end.split(":").map(Number);
          let diff = (eh + em/60) - (sh + sm/60);
          if (diff > 0) approvedHours += diff;
        }
      }
    });
    document.getElementById('approvedHours').textContent = approvedHours.toFixed(2);
    document.getElementById('approvedActivities').textContent = approvedCount;
  } catch (e) {
    document.getElementById('approvedHours').textContent = '0';
    document.getElementById('approvedActivities').textContent = '0';
  }
}

async function updateUnapprovedWidget() {
  let unapprovedCount = 0;
  let unapprovedHours = 0;
  try {
    const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${lastToken}`,
        'Accept': 'application/json'
      },
      credentials: 'include'
    });
    const data = await res.json();
    const activities = data.activities || [];
    activities.forEach(act => {
      if (!act.signed) {
        unapprovedCount++;
        // Calculate hours (if start/end time available)
        let start = act.start_time || act.startTime;
        let end = act.end_time || act.endTime;
        if (start && end) {
          const [sh, sm] = start.split(":").map(Number);
          const [eh, em] = end.split(":").map(Number);
          let diff = (eh + em/60) - (sh + sm/60);
          if (diff > 0) unapprovedHours += diff;
        }
      }
    });
    document.getElementById('unapprovedHours').textContent = unapprovedHours.toFixed(2);
    document.getElementById('unapprovedActivities').textContent = unapprovedCount;
  } catch (e) {
    document.getElementById('unapprovedHours').textContent = '0';
    document.getElementById('unapprovedActivities').textContent = '0';
  }
}

// Call on load and after activities update
updateApprovedWidget();
updateUnapprovedWidget();

// --- Leaderboard Section Script ---
async function fetchAndRenderLeaderboard() {
  const leaderboardBody = document.getElementById('leaderboardBody');
  const leaderboardStatus = document.getElementById('leaderboardStatus');
  leaderboardBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-4">Loading...</td></tr>';
  leaderboardStatus.textContent = '';
  try {
    const res = await fetch(`${API_URL}/leaderboard`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        ...(lastToken ? { 'Authorization': `Bearer ${lastToken}` } : {})
      },
      credentials: 'include'
    });
    if (!res.ok) throw new Error('Failed to fetch leaderboard');
    const data = await res.json();
    const leaderboard = data.leaderboard || [];
    if (leaderboard.length === 0) {
      leaderboardBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-4">No data available.</td></tr>';
      return;
    }
    leaderboardBody.innerHTML = leaderboard.map((entry, idx) => `
      <tr>
        <td class="px-6 py-4 whitespace-nowrap">${idx + 1}</td>
        <td class="px-6 py-4 whitespace-nowrap font-semibold">${entry.username || entry.name || ''}</td>
        <td class="px-6 py-4 whitespace-nowrap">${entry.approvedHours?.toFixed ? entry.approvedHours.toFixed(2) : entry.approvedHours || 0}</td>
      </tr>
    `).join('');
  } catch (err) {
    leaderboardBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-400 py-4">Error loading leaderboard.</td></tr>';
    leaderboardStatus.textContent = 'Could not load leaderboard.';
    leaderboardStatus.style.color = '#e74c3c';
  }
}
// Fetch leaderboard on page load
fetchAndRenderLeaderboard();
    </script>
    <script type="module" src="/public/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</body>
</html>

