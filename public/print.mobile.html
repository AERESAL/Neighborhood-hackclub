<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Print Activities | VolunteerHub (Mobile)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="dashboard-theme.css">
  <script src="dashboard-theme.js"></script>
  <style>
    :root {
      --accent: #2563eb;
      --color2: #22d3ee;
    }
    body {
      font-family: Lexend Deca, Montserrat, Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      width: 100vw;
      max-width: 100vw;
      margin: 0;
      background: rgba(255,255,255,0.98);
      border-radius: 0;
      box-shadow: none;
      padding: 12px 4px 24px 4px;
    }
    .preview {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0001;
      padding: 10px;
      margin-top: 16px;
    }
    .accent-btn {
      background: var(--accent, #2563eb);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: 600;
      font-size: 15px;
      transition: background 0.2s;
    }
    .accent-btn:hover {
      background: #1e40af;
    }
    .checkbox {
      accent-color: var(--accent, #2563eb);
      width: 18px;
      height: 18px;
    }
    header, aside { position: static !important; width: 100vw !important; }
    @media (min-width: 700px) {
      .container { max-width: 500px; margin: 40px auto; border-radius: 16px; box-shadow: 0 4px 24px #0001; }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <video autoplay muted loop id="backgroundVideo" class="prevent-select" style="position:fixed;width:100vw;height:100vh;object-fit:cover;z-index:-1;display:none;">
    <source src="https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4" type="video/mp4">
  </video>
    <!-- Mobile Header -->
    <header class="flex items-center justify-between bg-white shadow-md px-4 py-3 w-full z-50">
      <h1 class="text-lg font-bold text-gray-700">VolunteerHub</h1>
      <div class="relative flex items-center gap-2">
        <img src="https://via.placeholder.com/36" alt="Profile" class="w-9 h-9 rounded-full border border-gray-300 cursor-pointer" onclick="toggleMenu()">
        <div id="profileMenu" class="hidden absolute top-12 right-0 w-36 shadow-lg rounded-md z-50 border transition-colors">
          <ul class="py-2 text-sm" id="profileMenuList">
            <li><a href="#" class="block px-4 py-2">Profile</a></li>
            <li><button class="w-full text-left block px-4 py-2 text-red-600">Log Out</button></li>
          </ul>
        </div>
      </div>
    </header>
    <main class="flex-1 p-2 mt-2">
      <div class="container">
        <h2 class="text-xl font-bold text-gray-800 mb-3">Print Activities</h2>
        <div id="printStatus" class="mb-3 text-red-500"></div>
        <div id="activitiesList" class="mb-4"></div>
        <div id="totalHoursSection" class="mb-3 text-lg font-bold text-blue-700 flex items-center gap-2" style="display:none;">
          Total Hours: <span id="totalHoursValue">0</span>
        </div>
        <div class="flex gap-2 mb-3 flex-wrap">
          <button id="selectAllBtn" class="accent-btn flex-1">Select All</button>
          <button id="deselectAllBtn" class="accent-btn flex-1">Deselect All</button>
          <button id="printBtn" class="accent-btn flex-1">Print Selected</button>
        </div>
        <div class="preview" id="printPreview">
          <h3 class="text-base font-semibold mb-2">Preview</h3>
          <button id="previewPdfBtn" class="accent-btn mb-2">Open PDF Preview</button>
        </div>
      </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="dashboard-theme.js"></script>
    <script src="dashboard-core.js"></script>
    <script src="dashboard-activities.js"></script>
    <script>
      // Theme logic (reuse from desktop)
      function applyPrintWidgetTheme(theme) {
        var preview = document.getElementById('printPreview');
        if (preview && theme) {
          preview.style.background = theme.color3 || '#e0e0e0';
          preview.style.color = theme.textColor || '#000';
          preview.querySelectorAll('h1, h2, h3, h4, h5, h6, span, p, a, button, li, div').forEach(function(el) {
            el.style.color = theme.textColor || '#000';
          });
        }
      }
      const origApplyDashboardTheme = window.applyDashboardTheme;
      window.applyDashboardTheme = function(theme) {
        origApplyDashboardTheme(theme);
        applyPrintWidgetTheme(theme);
      };
      if (window.loadAndApplyDashboardTheme) {
        window.loadAndApplyDashboardTheme();
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          if (window.loadAndApplyDashboardTheme) window.loadAndApplyDashboardTheme();
        });
      }
    </script>
    <script>
      // Reuse the same JS logic as desktop (fetchActivities, renderActivitiesList, renderPreview, etc.)
      // You can include the same JS files or copy the relevant code here if needed.
      // If you want to keep all logic in dashboard-activities.js, just ensure it works for mobile layout.
    </script>
    <script>
      // Inline the print.html logic for activity selection and printing (reuse from desktop)
      const API_URL_LOCAL = "http://localhost:3000";
      const API_URL_PROD = "https://neighborhood-liard.vercel.app";
      const API_URL = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") ? API_URL_LOCAL : API_URL_PROD;
      let lastToken = localStorage.getItem('token');
      let currentUsername = localStorage.getItem('username');
      let activities = [];
      let selectedIds = new Set();
      const activitiesList = document.getElementById('activitiesList');
      const printStatus = document.getElementById('printStatus');
      async function fetchActivities() {
        if (!currentUsername || !lastToken) {
          printStatus.textContent = 'You must be logged in to view activities.';
          return;
        }
        try {
          const res = await fetch(`${API_URL}/activities/${currentUsername}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${lastToken}`,
              'Accept': 'application/json'
            }
          });
          const data = await res.json();
          activities = data.activities || [];
          renderActivitiesList();
          renderPreview();
        } catch {
          printStatus.textContent = 'Could not load activities.';
        }
      }
      function renderActivitiesList() {
        if (!activities.length) {
          activitiesList.innerHTML = '<div class="text-gray-400">No activities found.</div>';
          return;
        }
        let html = '<form id="activitiesForm">';
        activities.forEach(act => {
          const id = act.id || `${act.name}-${act.date}-${act.start_time}`;
          html += `<div class="flex items-center gap-2 mb-2">
            <input type="checkbox" class="checkbox" id="activity-${id}" data-id="${id}" ${selectedIds.has(id) ? 'checked' : ''}>
            <label for="activity-${id}" class="flex-1 cursor-pointer">
              <b>${act.name || act.title}</b> (${act.date})<br>
              ${act.start_time || ''} - ${act.end_time || ''} @ ${act.location || act.place || ''}<br>
              Supervisor: ${act.supervisorName || ''} (${act.supervisorEmail || ''})
            </label>
          </div>`;
        });
        html += '</form>';
        activitiesList.innerHTML = html;
        document.querySelectorAll('.checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const id = this.getAttribute('data-id');
            if (this.checked) selectedIds.add(id);
            else selectedIds.delete(id);
            renderPreview();
          });
        });
      }
      function renderPreview() {
        const totalHoursSection = document.getElementById('totalHoursSection');
        const totalHoursValue = document.getElementById('totalHoursValue');
        const selected = activities.filter(act => selectedIds.has(act.id || `${act.name}-${act.date}-${act.start_time}`));
        let total = 0;
        selected.forEach(act => {
          if (act.hours) {
            total += parseFloat(act.hours) || 0;
          } else if (act.start_time && act.end_time) {
            const [sh, sm] = act.start_time.split(':').map(Number);
            const [eh, em] = act.end_time.split(':').map(Number);
            let diff = (eh + em/60) - (sh + sm/60);
            if (diff < 0) diff += 24;
            total += diff;
          }
        });
        if (selected.length) {
          totalHoursSection.style.display = '';
          totalHoursValue.textContent = total.toFixed(2);
        } else {
          totalHoursSection.style.display = 'none';
          totalHoursValue.textContent = '0';
        }
        if (!activities.length || !selectedIds.size) {
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFont('helvetica', '');
        doc.setFontSize(18);
        doc.text('VolunteerHub Activities', 14, 18);
        doc.setFontSize(12);
        doc.text('Generated: ' + new Date().toLocaleString(), 14, 26);
        const head = [['#', 'Activity', 'Date', 'Time', 'Location', 'Supervisor', 'Signature']];
        const body = selected.map((act, i) => [
          i + 1,
          act.name || act.title || '',
          act.date || '',
          `${act.start_time || ''} - ${act.end_time || ''}`,
          act.location || act.place || '',
          `${act.supervisorName || ''} (${act.supervisorEmail || ''})`,
          act.signed && act.signatureData ? '' : 'Not signed'
        ]);
        doc.autoTable({
          head,
          body,
          startY: 32,
          styles: { fontSize: 10, cellPadding: 2 },
          headStyles: { fillColor: [37, 99, 235] },
          alternateRowStyles: { fillColor: [240, 244, 255] },
          didDrawCell: function (data) {
            if (data.column.index === 6 && data.row.index < selected.length) {
              const act = selected[data.row.index];
              if (act && act.signed && act.signatureData) {
                try {
                  const imgProps = doc.getImageProperties(act.signatureData);
                  const cellWidth = data.cell.width - 2;
                  const cellHeight = data.cell.height - 2;
                  let imgW = cellWidth, imgH = cellHeight;
                  if (imgProps.width / imgProps.height > cellWidth / cellHeight) {
                    imgH = imgW * imgProps.height / imgProps.width;
                  } else {
                    imgW = imgH * imgProps.width / imgProps.height;
                  }
                  const x = data.cell.x + (data.cell.width - imgW) / 2;
                  const y = data.cell.y + (data.cell.height - imgH) / 2;
                  doc.addImage(act.signatureData, 'PNG', x, y, imgW, imgH);
                } catch (e) {
                  doc.setFontSize(8);
                  doc.text('Invalid signature', data.cell.x + 2, data.cell.y + data.cell.height / 2);
                }
              }
            }
          }
        });
        const afterTableY = doc.lastAutoTable.finalY || 32 + 10 * (body.length + 1);
        doc.setFontSize(14);
        doc.setTextColor(37, 99, 235);
        doc.text(`Total Hours: ${total.toFixed(2)}`, 14, afterTableY + 14);
        const pageHeight = doc.internal.pageSize.getHeight();
        doc.setFontSize(10);
        doc.setTextColor(120);
        doc.text('VolunteerHub is an app developed by Sai Seelam.', 14, pageHeight - 10);
        const previewBtn = document.getElementById('previewPdfBtn');
        previewBtn.onclick = function(e) {
          e.preventDefault();
          const blob = doc.output('blob');
          const blobUrl = URL.createObjectURL(blob);
          const win = window.open(blobUrl, '_blank');
          if (!win) {
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = 'VolunteerHub-Activities.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        };
      }
      document.getElementById('selectAllBtn').onclick = function() {
        activities.forEach(act => selectedIds.add(act.id || `${act.name}-${act.date}-${act.start_time}`));
        renderActivitiesList();
        renderPreview();
      };
      document.getElementById('deselectAllBtn').onclick = function() {
        selectedIds.clear();
        renderActivitiesList();
        renderPreview();
      };
      document.getElementById('printBtn').onclick = function() {
        if (!selectedIds.size) {
          printStatus.textContent = 'Select at least one activity to print.';
          return;
        }
        printStatus.textContent = '';
        window.print();
      };
      fetchActivities();
    </script>
</body>
</html>
