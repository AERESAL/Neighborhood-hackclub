<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolunteerHub Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .container { width: 75vw; height: 75vh; position: relative; margin: auto; border: 2px solid gray; background-color: rgba(200, 200, 200, 0.2); }
        header { background-color: rgba(255, 255, 255, 0.75); }
        aside { background-color: rgba(255, 255, 255, 0.75); }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <!-- Header -->
    <header class="flex items-center justify-between bg-white shadow-md px-6 py-4 fixed top-0 left-0 w-full z-50">
        <h1 class="text-xl font-bold text-gray-700">VolunteerHub</h1>
        <div class="relative flex items-center gap-4">
            <!-- Profile -->
            <img src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full border border-gray-300 cursor-pointer" onclick="toggleMenu()">
            <div id="profileMenu" class="hidden absolute top-16 right-0 w-44 shadow-lg rounded-md z-50 border transition-colors">
                <ul class="py-2 text-sm" id="profileMenuList">
                    <li><a href="#" class="block px-4 py-2">Profile</a></li>
                    <li><button class="w-full text-left block px-4 py-2 text-red-600">Log Out</button></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Layout Wrapper -->
    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside class="w-64 h-[100vh] bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-200 shadow-md flex flex-col justify-between fixed pt-24">
            <nav class="mt-6 flex-1">
                <ul class="space-y-2">
                    <li><a href="dashboard.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Activities</a></li>
                    <li><a href="#" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">Leaderboard</a></li>
                    <li><a href="#" class="block px-6 py-3 text-gray-700 hover:bg-gray-200">My Hours</a></li>
                    <li><a href="community.html" class="block px-6 py-3 text-gray-700 hover:bg-gray-200 font-bold">Community</a></li>
                </ul>
            </nav>
            <div class="flex items-center justify-center gap-4 mb-4 px-6">
                <button id="sidebarSettingsBtn" class="w-10 h-10 text-gray-600 hover:text-gray-800" style="padding-bottom: 10px;">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" class="themed-icon"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
                </button>
                <button id="sidebarPrintBtn" class="w-10 h-10 text-gray-600 hover:text-gray-800" style="padding-bottom: 10px;">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" class="themed-icon"><path d="M640-640v-120H320v120h-80v-200h480v200h-80Zm-480 80h640-640Zm560 100q17 0 28.5-11.5T760-500q0-17-11.5-28.5T720-540q-17 0-28.5 11.5T680-500q0 17 11.5 28.5T720-460Zm-80 260v-160H320v160h320Zm80 80H240v-160H80v-240q0-51 35-85.5t85-34.5h560q51 0 85.5 34.5T880-520v240H720v160Zm80-240v-160q0-17-11.5-28.5T760-560H200q-17 0-28.5 11.5T160-520v160h80v-80h480v80h80Z"/></svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 ml-64 relative mt-[64px]">
            <div class="bg-white bg-opacity-80 rounded-md shadow-md p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Community</h2>
                <p class="text-gray-700">Welcome to the VolunteerHub Community page! Here you can connect with other volunteers, share your experiences, and find new opportunities to get involved.</p>
                <!-- Posts Section -->
                <section id="postsSection" class="mt-8">
                  <h3 class="text-2xl font-semibold text-gray-800 mb-4">Posts</h3>
                  <div id="postsList" class="space-y-4">
                    <div class="bg-gray-100 rounded p-4 shadow">
                      <div class="font-bold text-lg text-gray-700">Welcome to the Community!</div>
                      <div class="text-gray-600 mt-1">Introduce yourself and share your volunteering stories here.</div>
                      <div class="text-xs text-gray-400 mt-2">VolunteerHub Team â€¢ May 29, 2025</div>
                    </div>
                  </div>
                  <form id="addPostForm" class="mt-6 flex flex-col gap-2">
                    <textarea id="postContent" class="border rounded px-3 py-2" rows="3" placeholder="Share something with the community..." required></textarea>
                    <input type="file" accept="image/*" id="postImage" class="border rounded px-3 py-2">
                    <button type="submit" class="self-end px-4 py-2 bg-blue-600 text-white rounded">Post</button>
                  </form>
                </section>
                <!-- End Posts Section -->
            </div>
        </main>
    </div>
    <video autoplay muted loop id="backgroundVideo" class="prevent-select" style="position:fixed;width:100%;height:100%;object-fit:cover;z-index:-1;top:0;left:0;"><source src="https://cdn.pixabay.com/video/2023/02/16/150883-799711528_large.mp4" type="video/mp4"></video>
    <script src="/public/dashboard-core.js"></script>
    <script src="/public/dashboard-theme.js"></script>
    <script src="/public/dashboard-ui.js"></script>
    <script>
// Apply theme color to all .themed-icon SVGs
function applyThemedIcons(color) {
  document.querySelectorAll('.themed-icon').forEach(svg => {
    svg.style.color = color;
    svg.setAttribute('fill', color);
    svg.querySelectorAll('path').forEach(path => path.setAttribute('fill', color));
  });
}
window.applyThemedIcons = applyThemedIcons;

// Force theme application after dashboard-theme.js loads
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    if (window.applyThemeFromSettings) {
      window.applyThemeFromSettings();
    } else if (window.applyTheme) {
      window.applyTheme();
    }
  }, 0);
});

const API_URL = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
  ? "http://localhost:3000"
  : "https://neighborhood-liard.vercel.app";

// Fetch and render posts
async function fetchAndRenderPosts() {
  const postsList = document.getElementById('postsList');
  postsList.innerHTML = '<div class="text-gray-400">Loading posts...</div>';
  try {
    const res = await fetch(`${API_URL}/api/community-posts`);
    const data = await res.json();
    postsList.innerHTML = '';
    if (!data.posts || data.posts.length === 0) {
      postsList.innerHTML = '<div class="text-gray-400">No posts yet.</div>';
      return;
    }
    data.posts.forEach(post => {
      const div = document.createElement('div');
      div.className = 'bg-gray-100 rounded p-4 shadow';
      let canDelete = false;
      const currentUser = localStorage.getItem('username') || '';
      if (post.author && post.author === currentUser) canDelete = true;
      // Fix image URL to be absolute if needed
      let imageUrl = post.imageUrl;
      if (imageUrl && imageUrl.startsWith('/uploads/')) {
        imageUrl = `${API_URL}${imageUrl}`;
      }
      div.innerHTML = `
        <div class="font-bold text-lg text-gray-700">${post.author || 'Anonymous'}</div>
        <div class="text-gray-600 mt-1">${post.content}</div>
        ${imageUrl ? `<img src="${imageUrl}" alt="Post image" class="mt-2 max-h-60 rounded shadow" style="max-width:100%">` : ''}
        <div class="text-xs text-gray-400 mt-2">${new Date(post.createdAt).toLocaleString()}</div>
        ${canDelete ? `<button class="delete-post-btn mt-2 px-3 py-1 bg-red-500 text-white rounded text-xs" data-id="${post.id}">Delete</button>` : ''}
      `;
      postsList.appendChild(div);
    });
    // Attach delete handlers
    document.querySelectorAll('.delete-post-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        if (!confirm('Delete this post?')) return;
        const postId = this.getAttribute('data-id');
        const username = localStorage.getItem('username') || '';
        try {
          const res = await fetch(`${API_URL}/api/community-posts/${postId}?username=${encodeURIComponent(username)}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Failed to delete');
          fetchAndRenderPosts();
        } catch (err) {
          alert('Failed to delete post.');
        }
      });
    });
  } catch (err) {
    postsList.innerHTML = '<div class="text-red-500">Failed to load posts.</div>';
  }
}

// Handle new post submission
const addPostForm = document.getElementById('addPostForm');
if (addPostForm) {
  addPostForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const postContent = document.getElementById('postContent').value.trim();
    const author = localStorage.getItem('username') || 'Anonymous';
    const imageInput = document.getElementById('postImage');
    const formData = new FormData();
    formData.append('content', postContent);
    formData.append('author', author);
    if (imageInput && imageInput.files[0]) {
      formData.append('image', imageInput.files[0]);
    }
    try {
      const res = await fetch(`${API_URL}/api/community-posts`, {
        method: 'POST',
        body: formData
      });
      if (!res.ok) throw new Error('Failed to post');
      addPostForm.reset();
      fetchAndRenderPosts();
    } catch (err) {
      alert('Failed to post.');
    }
  });
}

// Add image upload field to the form
(function addImageField() {
  const form = document.getElementById('addPostForm');
  if (form && !document.getElementById('postImage')) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.id = 'postImage';
    fileInput.className = 'border rounded px-3 py-2';
    fileInput.style.marginTop = '4px';
    form.insertBefore(fileInput, form.querySelector('button'));
  }
})();

// Initial load
window.addEventListener('DOMContentLoaded', fetchAndRenderPosts);
</script>
</body>
</html>
